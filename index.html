<!DOCTYPE html>
<html lang="pt-BR" id="html-lang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Importando a fonte Noto Sans do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <!-- Incluindo bibliotecas JS para PDF e Gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <title data-translate-key="page_title">Plataforma de Avaliação de Livros</title>
    <style>
        :root {
            --primary-color: #34495e;
            --secondary-color: #2c3e50;
            --accent-color: #3498db;
            --text-color: #333;
            --light-gray: #f8f9fa;
            --white: #fff;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #ecf0f1;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 950px;
            width: 100%;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 20px auto;
        }
        
        /* --- HEADER E NAVEGAÇÃO PRINCIPAL --- */
        .main-header {
            background: var(--secondary-color);
            color: var(--white);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .main-header h1 { font-size: 1.5em; cursor: pointer; margin-right: auto; }
        .lang-switcher { display: flex; align-items: center; gap: 5px; } /* Adicionado gap */
        .lang-btn { background: transparent; border: 1px solid var(--white); color: var(--white); padding: 5px 10px; cursor: pointer; border-radius: 5px; opacity: 0.7; }
        .lang-btn.active { background-color: rgba(255,255,255,0.3); }

        .screen { display: none; }
        .screen.active { display: block; }
        .screen-content { padding: 30px 40px; }
        
        /* --- TELA INICIAL (HOME) --- */
        .thesis-header { padding: 30px; text-align: center; background-color: var(--light-gray); border-bottom: 1px solid #ddd; }
        .thesis-header .institution { font-size: 1.1em; font-weight: bold; color: var(--primary-color); }
        .thesis-header .campus-course { font-size: 1em; color: #555; margin-bottom: 20px; }
        .thesis-header .author-name { font-size: 1.4em; font-weight: bold; color: var(--secondary-color); margin: 20px 0; text-transform: uppercase; }
        .thesis-header .thesis-title { font-size: 1.2em; font-weight: bold; max-width: 600px; margin: 0 auto 10px auto; }
        .thesis-header .thesis-subtitle { font-size: 1em; font-style: italic; color: #555; margin-bottom: 30px; }
        .thesis-header .advisor { font-size: 0.9em; color: #666; }
        #home-screen .start-section { text-align: center; padding: 40px 20px; }
        #home-start-btn { padding: 15px 30px; font-size: 1.2em; font-weight: bold; color: var(--white); background-color: var(--success); border: none; border-radius: 30px; cursor: pointer; transition: all 0.3s ease; }
        #home-start-btn:hover { background-color: #219d52; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        #home-screen .instructions-section { padding: 40px 20px; }
        #home-screen .instructions-section h3 { text-align: center; font-size: 1.8em; color: var(--secondary-color); margin-bottom: 30px; }
        .steps-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
        .step { text-align: center; width: 200px; }
        .step .step-number {
            width: 60px;
            height: 68px;
            background-color: var(--accent-color);
            color: var(--white);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 15px;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        .step .step-text { font-size: 1em; color: #555; min-height: 50px; }


        /* --- TELA DE INÍCIO (SETUP) --- */
        #setup-screen h2 { color: var(--secondary-color); margin-bottom: 20px; text-align: center; }
        .form-section { margin-bottom: 25px; border-left: 4px solid var(--accent-color); padding-left: 15px; }
        .form-section h3 { margin-bottom: 15px; color: var(--primary-color); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .form-group .optional-text { font-size: 0.8em; opacity: 0.7; font-weight: normal; margin-left: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; font-family: 'Noto Sans', sans-serif; }
        textarea { resize: vertical; min-height: 80px; }
        .start-btn { display: block; width: 100%; padding: 15px; background-color: var(--success); color: var(--white); border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        .start-btn:hover { background-color: #219d52; }
        
        /* --- TELA DE AVALIAÇÃO --- */
        #progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 20px; }
        #progress-bar { width: 0%; height: 10px; background-color: var(--accent-color); border-radius: 5px; transition: width 0.4s ease; }
        .dimension-container { min-height: 400px; padding: 20px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; background-color: var(--light-gray); }
        .dimension-title { font-size: 1.5em; font-weight: bold; margin-bottom: 25px; color: var(--secondary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; }
        .criterion-group { margin-bottom: 30px; }
        .criterion-group-title { font-size: 1.2em; font-weight: bold; color: var(--primary-color); margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .checklist-item { margin-bottom: 20px; padding: 15px; border-radius: 5px; background-color: var(--white); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .checklist-item p { margin-bottom: 10px; font-size: 1.05em; line-height: 1.5; }
        .rating-area { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; flex-wrap: wrap; gap: 10px; }
        .rating-area span { font-size: 0.9em; opacity: 0.8; }
        .rating-buttons { display: flex; gap: 5px; }
        .rating-buttons label { cursor: pointer; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid #ccc; font-weight: bold; transition: all 0.2s; }
        .rating-buttons input[type="radio"] { display: none; }
        .rating-buttons input[type="radio"]:checked + label { background-color: var(--accent-color); color: var(--white); border-color: var(--accent-color); transform: scale(1.1); }
        #observation-section { margin-top: 30px; }
        #observation-section label { font-weight: bold; color: var(--primary-color); }
        #observation-textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; margin-top: 10px; }
        .navigation-controls { display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #prev-btn { background-color: #ddd; }
        #prev-btn:disabled { background-color: #eee; cursor: not-allowed; }
        #next-btn { background-color: var(--primary-color); color: var(--white); }

        /* --- TELA DE RESULTADOS --- */
        #results-screen h2 { text-align: center; color: var(--secondary-color); margin-bottom: 20px; }
        #book-title-result { text-align: center; font-weight: bold; font-size: 1.2em; color: var(--primary-color); margin-bottom: 20px; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: flex-start; }
        #chart-container { max-width: 400px; margin: 0 auto; }
        .scores-container .result-box { padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .scores-container h3 { margin: 0 0 10px 0; font-size: 1.1em; }
        .dimension-score-bar { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 5px; }
        .dimension-score-bar div { height: 10px; background-color: var(--accent-color); border-radius: 5px; transition: width 0.5s; }
        #essential-warning { background-color: #fbeae9; border-left: 5px solid var(--danger); color: var(--danger); display: none; font-weight: bold; }
        #recommendation, #observations-summary { grid-column: 1 / -1; margin-top: 20px; padding: 20px; border-radius: 8px; }
        #observations-summary { background-color: var(--light-gray); border-left: 5px solid #bdc3c7; }
        #observations-summary h3 { color: var(--secondary-color); }
        #observations-summary .obs-item { margin-bottom: 15px; }
        #observations-summary .obs-item strong { color: var(--primary-color); display: block; margin-bottom: 5px;}
        #observations-summary .obs-item p { white-space: pre-wrap; word-wrap: break-word; }
        .action-buttons { text-align: center; margin-top: 30px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .action-btn { padding: 12px 25px; border-radius: 25px; font-size: 1em; font-weight: bold; cursor: pointer; border: none; transition: all 0.3s ease; }
        #export-pdf-btn { background-color: var(--primary-color); color: var(--white); }
        #new-eval-btn { background-color: var(--success); color: var(--white); }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .footer { padding: 20px 40px; text-align: center; font-size: 0.9em; background-color: #e0e0e0; border-top: 1px solid #ccc; color: #666;}
        .footer a { color: var(--primary-color); font-weight: bold; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .results-grid { grid-template-columns: 1fr; }
            .screen-content { padding: 20px 15px; }
            .main-header { flex-direction: column; gap: 10px; }
            .main-header h1 { order: -1; }
            .thesis-header { padding: 20px; }
            .thesis-header h2 { font-size: 1.1em; }
            .steps-container { flex-direction: column; align-items: center; }
            .rating-area { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1 id="header-title" data-translate-key="page_title">Plataforma de Avaliação</h1>
            <div class="lang-switcher">
                <button class="lang-btn active" id="lang-pt">PT</button>
                <button class="lang-btn" id="lang-en">EN</button>
            </div>
        </header>
        
        <!-- Screen 0: Home -->
        <div id="home-screen" class="screen active">
             <div class="thesis-header">
                 <p class="institution" data-translate-key="thesis_institution">Instituto Federal de Brasília</p>
                 <p class="campus-course" data-translate-key="thesis_campus_course">Campus Riacho Fundo - Licenciatura em Letras Inglês</p>
                 <p class="author-name" data-translate-key="thesis_author">João Vicente Saliba de Andrade</p>
                 <h2 class="thesis-title" data-translate-key="thesis_title">Critérios para a Escolha de Livros Didáticos de Língua Inglesa a Partir da Abordagem Comunicativa</h2>
                 <p class="thesis-subtitle" data-translate-key="thesis_subtitle">Um Guia para Estudantes de Letras Inglês</p>
                 <p class="advisor" data-translate-key="thesis_advisor_info">Trabalho de Conclusão de Curso apresentado sob orientação de Ma. Maria Antonia Germano dos Santos Maia</p>
             </div>
             <div class="start-section">
                <button id="home-start-btn" data-translate-key="home_start_btn">Iniciar Avaliação</button>
             </div>
             <div class="instructions-section">
                <h3 data-translate-key="home_how_to_use">Como Usar</h3>
                <div class="steps-container">
                    <div class="step">
                        <div class="step-number">1</div>
                        <p class="step-text" data-translate-key="home_step_1">Preencha os detalhes do livro e o contexto de ensino.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <p class="step-text" data-translate-key="home_step_2">Avalie os itens de cada dimensão usando a escala.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <p class="step-text" data-translate-key="home_step_3">Analise os resultados e a recomendação final.</p>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <p class="step-text" data-translate-key="home_step_4">Exporte o relatório detalhado em PDF, se desejar.</p>
                    </div>
                </div>
             </div>
        </div>

        <!-- Screen 1: Setup -->
        <div id="setup-screen" class="screen">
            <div class="screen-content">
                <h2 data-translate-key="setup_title">Informações do Livro e Contexto</h2>
                <form id="setup-form">
                    <div class="form-section">
                        <h3 data-translate-key="book_details_title">Detalhes do Livro</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="book-title" data-translate-key="book_title">Título do Livro</label><input type="text" id="book-title" required></div>
                            <div class="form-group"><label for="book-author" data-translate-key="book_author">Autor(es)<span class="optional-text">(opcional)</span></label><input type="text" id="book-author"></div>
                            <div class="form-group"><label for="book-publisher" data-translate-key="book_publisher">Editora<span class="optional-text">(opcional)</span></label><input type="text" id="book-publisher"></div>
                            <div class="form-group"><label for="book-year" data-translate-key="book_year">Ano<span class="optional-text">(opcional)</span></label><input type="number" id="book-year"></div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3 data-translate-key="context_details_title">Contexto de Ensino</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="course-type" data-translate-key="course_type">Tipo de Curso</label><input type="text" id="course-type" placeholder="Ex: Inglês Geral, Preparatório..."></div>
                            <div class="form-group"><label for="student-profile" data-translate-key="student_profile">Perfil dos Alunos</label><textarea id="student-profile" placeholder="Ex: Adolescentes, B1, 12 alunos..."></textarea></div>
                        </div>
                    </div>
                    <button type="submit" class="start-btn" data-translate-key="start_btn">Continuar para Avaliação</button>
                </form>
            </div>
        </div>

        <!-- Screen 2: Evaluation -->
        <div id="evaluation-screen" class="screen">
            <div class="screen-content">
                <div id="progress-bar-container"><div id="progress-bar"></div></div>
                <div class="dimension-container" id="dimension-container"></div>
                <div class="navigation-controls">
                    <button id="prev-btn" class="nav-btn" data-translate-key="prev_btn">Anterior</button>
                    <span id="progress-text"></span>
                    <button id="next-btn" class="nav-btn" data-translate-key="next_btn">Próximo</button>
                </div>
            </div>
        </div>

        <!-- Screen 3: Results -->
        <div id="results-screen" class="screen">
            <div class="screen-content" id="report-content">
                <h2 data-translate-key="results_title">Resultados da Avaliação</h2>
                <p id="book-title-result"></p>
                <div class="results-grid">
                    <div id="chart-container"><canvas id="results-chart"></canvas></div>
                    <div class="scores-container" id="scores-container">
                        <!-- Dimension scores will be injected here -->
                    </div>
                </div>
                <div id="essential-warning" class="result-box"></div>
                <div id="recommendation" class="result-box"></div>
                <div id="observations-summary" class="result-box">
                    <h3 data-translate-key="observations_title">Observações por Dimensão</h3>
                    <div id="observations-list"></div>
                </div>
            </div>
            <div class="action-buttons screen-content">
                 <button id="new-eval-btn" class="action-btn" data-translate-key="nav_new_eval">Fazer Nova Avaliação</button>
                 <button id="export-pdf-btn" class="action-btn" data-translate-key="export_btn">Exportar PDF</button>
            </div>
        </div>

        <footer class="footer">
            <p data-translate-key="footer_text">Desenvolvido por <a href="https://www.linkedin.com/in/joaosvicente/" target="_blank" rel="noopener noreferrer">João Vicente Saliba de Andrade</a></p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA & CONFIG ---
        const translations = {
            pt: {
                page_title: "Plataforma de Avaliação de Livros",
                nav_new_eval: "Fazer Nova Avaliação",
                home_title: "Guia de Avaliação de Livros Didáticos de Inglês",
                home_intro: "Uma ferramenta prática para professores, adaptada de um Trabalho de Conclusão de Curso (Letras-Inglês, IFB). Avalie materiais de forma criteriosa e fundamentada na Abordagem Comunicativa e no QECR.",
                home_start_btn: "Iniciar Avaliação", home_how_to_use: "Como Usar",
                home_step_1: "Preencha os detalhes do livro e o contexto de ensino.", home_step_2: "Avalie os itens de cada dimensão usando a escala.", home_step_3: "Analise os resultados e a recomendação final.", home_step_4: "Exporte o relatório detalhado em PDF, se desejar.",
                thesis_institution: "Instituto Federal de Brasília",
                thesis_campus_course: "Campus Riacho Fundo - Licenciatura em Letras Inglês",
                thesis_author: "João Vicente Saliba de Andrade",
                thesis_title: "Critérios para a Escolha de Livros Didáticos de Língua Inglesa a Partir da Abordagem Comunicativa",
                thesis_subtitle: "Um Guia para Estudantes de Letras Inglês",
                thesis_advisor_info: "Trabalho de Conclusão de Curso apresentado sob orientação de Ma. Maria Antonia Germano dos Santos Maia",
                setup_title: "Informações do Livro e Contexto", book_details_title: "Detalhes do Livro", book_title: "Título do Livro", book_author: "Autor(es)", book_publisher: "Editora", book_year: "Ano",
                context_details_title: "Contexto de Ensino", course_type: "Tipo de Curso", student_profile: "Perfil dos Alunos", start_btn: "Continuar para Avaliação",
                prev_btn: "Anterior", next_btn: "Próximo", finish_btn: "Ver Resultados",
                results_title: "Resultados da Avaliação", total_score: "Pontuação Geral", export_btn: "Exportar PDF",
                progress_text: "Dimensão {current} de {total}",
                likert_1: "Discordo", likert_5: "Concordo",
                observations_title: "Observações por Dimensão",
                observation_label: "Observações sobre esta Dimensão:",
                essential_warning_text: "<strong>ALERTA:</strong> Um ou mais itens essenciais receberam nota baixa (1 ou 2).",
                recommendation_excellent: "<h3>✅ DECISÃO: ADOTAR</h3><p>O livro está fortemente alinhado com os princípios comunicativos. Constitui uma base sólida para o curso.</p>",
                recommendation_good: "<h3>⚠️ DECISÃO: ADOTAR COM ADAPTAÇÕES</h3><p>O livro apresenta um alinhamento razoável, mas possui lacunas. O professor deverá estar preparado para suplementar as áreas deficientes.</p>",
                recommendation_poor: "<h3>❌ DECISÃO: REJEITAR</h3><p>O livro está fracamente alinhado com os princípios comunicativos. O esforço para adaptar seria maior do que procurar uma alternativa.</p>",
                pdf_report_title: "Relatório de Avaliação de Livro Didático",
                footer_text: `Desenvolvido por <a href="https://www.linkedin.com/in/joaosvicente/" target="_blank" rel="noopener noreferrer">João Vicente Saliba de Andrade</a>`
            },
            en: {
                page_title: "Textbook Evaluation Platform",
                nav_new_eval: "New Evaluation",
                home_title: "English Textbook Evaluation Guide",
                home_intro: "A practical tool for teachers, adapted from a Graduation Thesis (English Major, IFB). Evaluate materials critically, based on the Communicative Approach and the CEFR.",
                home_start_btn: "Start Evaluation", home_how_to_use: "How to Use",
                home_step_1: "Fill in the book details and teaching context.", home_step_2: "Rate the items in each dimension using the scale.", home_step_3: "Analyze the score, chart, and final recommendation.", home_step_4: "Export the detailed report to PDF if you wish.",
                thesis_institution: "Federal Institute of Brasília",
                thesis_campus_course: "Riacho Fundo Campus - Bachelor's Degree in English Language Arts",
                thesis_author: "João Vicente Saliba de Andrade",
                thesis_title: "Criteria for Selecting English Language Textbooks Based on the Communicative Approach",
                thesis_subtitle: "A Guide for English Major Students",
                thesis_advisor_info: "Graduation Thesis presented under the supervision of Ma. Maria Antonia Germano dos Santos Maia",
                setup_title: "Book Information and Context", book_details_title: "Book Details", book_title: "Book Title", book_author: "Author(s)", book_publisher: "Publisher", book_year: "Year",
                context_details_title: "Teaching Context", course_type: "Course Type", student_profile: "Student Profile", start_btn: "Continue to Evaluation",
                prev_btn: "Previous", next_btn: "Next", finish_btn: "See Results",
                results_title: "Evaluation Results", total_score: "Overall Score", export_btn: "Export PDF",
                progress_text: "Dimension {current} of {total}",
                likert_1: "Disagree", likert_5: "Agree",
                observations_title: "Observations per Dimension",
                observation_label: "Observations on this Dimension:",
                essential_warning_text: "<strong>WARNING:</strong> One or more essential items received a low score (1 or 2).",
                recommendation_excellent: "<h3>✅ DECISION: ADOPT</h3><p>The textbook is strongly aligned with communicative principles. It provides a solid foundation for the course.</p>",
                recommendation_good: "<h3>⚠️ DECISION: ADOPT WITH ADAPTATIONS</h3><p>The textbook shows reasonable alignment but has gaps. The teacher should be prepared to supplement deficient areas.</p>",
                recommendation_poor: "<h3>❌ DECISION: REJECT</h3><p>The textbook is weakly aligned with communicative principles. The effort to adapt it would be greater than finding a more suitable alternative.</p>",
                pdf_report_title: "Textbook Evaluation Report",
                footer_text: `Developed by <a href="https://www.linkedin.com/in/joaosvicente/" target="_blank" rel="noopener noreferrer">João Vicente Saliba de Andrade</a>`
            }
        };

        const dimensionsData = [
            { // Dimensão 1
                pt: "Fundamentação Pedagógica e Alinhamento Curricular", en: "Pedagogical Foundation and Curricular Alignment",
                acronym_pt: "FPAC", acronym_en: "PFCA",
                criteria: [
                    { title_pt: "Critério 1: Coerência com a Abordagem Comunicativa (AC)", title_en: "Criterion 1: Coherence with Communicative Approach (CA)", items: [
                        { id: 'c1_1', essential: true, pt: 'As unidades são organizadas em torno de funções comunicativas (ex: "dar conselhos") ou em torno de tópicos gramaticais isolados (ex: "Present Perfect")?', en: 'Are units organized around communicative functions (e.g., "giving advice") or around isolated grammatical topics (e.g., "Present Perfect")?' },
                        { id: 'c1_2', essential: true, pt: "A gramática é apresentada como uma ferramenta para a comunicação ou como um fim em si mesma?", en: "Is grammar presented as a tool for communication or as an end in itself?"},
                        { id: 'c1_3', essential: true, pt: "O livro me fornece atividades que levam ao uso real da língua ou se limita a exercícios mecânicos de repetição e preenchimento de lacunas?", en: "Does the book provide me with activities that lead to real language use or is it limited to mechanical repetition and fill-in-the-blank exercises?"}
                    ]},
                    { title_pt: "Critério 2: Alinhamento com o QECR", title_en: "Criterion 2: Alignment with CEFR", items: [
                        { id: 'c2_1', essential: true, pt: "O livro indica claramente a qual nível do Quadro Europeu Comum de Referência (A1, A2, B1, etc.) ele se destina?", en: "Does the book clearly indicate which level of the Common European Framework of Reference (A1, A2, B1, etc.) it is intended for?" },
                        { id: 'c2_2', essential: false, pt: 'Os objetivos de cada unidade são descritos em termos de capacidades práticas e observáveis ("can-do statements"), como "Ao final da lição, o aluno será capaz de..."?', en: 'Are the objectives of each unit described in terms of practical and observable abilities ("can-do statements"), such as "By the end of the lesson, the student will be able to..."?' },
                        { id: 'c2_3', essential: false, pt: "As tarefas e avaliações propostas são visivelmente coerentes com as competências esperadas para o nível declarado?", en: "Are the proposed tasks and assessments visibly consistent with the competencies expected for the declared level?"}
                    ]},
                    { title_pt: "Critério 3: Adequação ao contexto de ensino", title_en: "Criterion 3: Suitability for Teaching Context", items: [
                        { id: 'c3_1', essential: false, pt: "Os temas, imagens e situações do livro são relevantes e interessantes para a faixa etária e o perfil sociocultural dos meus alunos?", en: "Are the themes, images, and situations in the book relevant and interesting for the age group and sociocultural profile of my students?" },
                        { id: 'c3_2', essential: false, pt: "O material é flexível o suficiente para ser adaptado aos objetivos específicos do meu curso (geral, negócios, preparatório) e à minha carga horária?", en: "Is the material flexible enough to be adapted to the specific objectives of my course (general, business, preparatory) and to my workload?"},
                        { id: 'c3_3', essential: false, pt: "O livro considera diferentes estilos de aprendizagem, oferecendo uma variedade de tipos de atividade (visuais, auditivas, cinestésicas)?", en: "Does the book consider different learning styles by offering a variety of activity types (visual, auditory, kinesthetic)?"}
                    ]}
                ]
            },
            { // Dimensão 2
                pt: "Desenvolvimento da Competência Comunicativa", en: "Communicative Competence Development",
                acronym_pt: "DCC", acronym_en: "CCD",
                criteria: [
                     { title_pt: "Critério 4: Competência gramatical/linguística", title_en: "Criterion 4: Grammatical/Linguistic Competence", items: [
                        { id: 'c4_1', essential: false, pt: "A gramática é apresentada dentro de contextos significativos (diálogos, textos), facilitando a compreensão de seu uso?", en: "Is grammar presented within meaningful contexts (dialogues, texts), facilitating the understanding of its use?" },
                        { id: 'c4_2', essential: false, pt: "As atividades de prática incentivam o uso indutivo e a descoberta das regras pelos alunos, ou dependem exclusivamente de explicação explícita?", en: "Do practice activities encourage inductive use and discovery of rules by students, or do they rely solely on explicit explanation?"}
                    ]},
                     { title_pt: "Critério 5: Competência sociolinguística/interacional", title_en: "Criterion 5: Sociolinguistic/Interactional Competence", items: [
                        { id: 'c5_1', essential: false, pt: "O livro expõe os alunos a diferentes registros de fala (formal, informal, neutro) e ensina quando usar cada um?", en: "Does the book expose students to different speech registers (formal, informal, neutral) and teach when to use each?" },
                        { id: 'c5_2', essential: false, pt: "As atividades trabalham a adequação da linguagem ao contexto social (ex: como falar com uma autoridade vs. como falar com um amigo)?", en: "Do the activities address the appropriateness of language to the social context (e.g., how to speak to an authority figure vs. how to speak to a friend)?"}
                    ]},
                     { title_pt: "Critério 6: Competência discursiva", title_en: "Criterion 6: Discourse Competence", items: [
                        { id: 'c6_1', essential: false, pt: "O material vai além do ensino de frases isoladas, ajudando os alunos a estruturar textos maiores e mais complexos (parágrafos, e-mails, narrativas)?", en: "Does the material go beyond teaching isolated sentences, helping students to structure larger and more complex texts (paragraphs, emails, narratives)?" },
                        { id: 'c6_2', essential: false, pt: "O uso de conectores e outros elementos de coesão textual é ensinado e praticado de forma clara?", en: "Is the use of connectors and other textual cohesion elements taught and practiced clearly?"}
                    ]},
                     { title_pt: "Critério 7: Competência estratégica", title_en: "Criterion 7: Strategic Competence", items: [
                        { id: 'c7_1', essential: false, pt: "O livro ensina, de forma explícita ou implícita, estratégias para lidar com falhas na comunicação (ex: pedir clarificação, parafrasear, usar gestos)?", en: "Does the book, explicitly or implicitly, teach strategies for dealing with communication breakdowns (e.g., asking for clarification, paraphrasing, using gestures)?"},
                        { id: 'c7_2', essential: false, pt: "Existem atividades que encorajam os alunos a se arriscarem e se comunicarem mesmo com um repertório linguístico limitado?", en: "Are there activities that encourage students to take risks and communicate even with a limited linguistic repertoire?"}
                    ]}
                ]
            },
            { // Dimensão 3
                pt: "Qualidade das Tarefas, Autenticidade e Interação", en: "Task Quality, Authenticity, and Interaction",
                acronym_pt: "QTAI", acronym_en: "TQAI",
                criteria: [
                    { title_pt: "Critério 8: Tipologia e qualidade das tarefas", title_en: "Criterion 8: Task Type and Quality", items: [
                        { id: 'c8_1', essential: true, pt: 'As atividades principais de cada unidade são "tarefas" com um objetivo comunicativo real (ex: resolver um problema, criar um produto) ou são apenas exercícios linguísticos?', en: 'Are the main activities of each unit "tasks" with a real communicative objective (e.g., solving a problem, creating a product) or are they just linguistic exercises?' },
                        { id: 'c8_2', essential: true, pt: "As tarefas propostas exigem que os alunos foquem primariamente no significado e na mensagem para chegar a um resultado?", en: "Do the proposed tasks require students to focus primarily on meaning and message to achieve a result?"}
                    ]},
                    { title_pt: "Critério 9: Autenticidade", title_en: "Criterion 9: Authenticity", items: [
                        { id: 'c9_1', essential: true, pt: "O livro utiliza textos e áudios autênticos ou semi-autênticos (artigos, podcasts, vídeos reais) que exponham os alunos à língua como ela é usada no mundo real?", en: "Does the book use authentic or semi-authentic texts and audio (articles, podcasts, real videos) that expose students to the language as it is used in the real world?" },
                        { id: 'c9_2', essential: true, pt: "As tarefas propostas simulam situações de uso da língua que são críveis e relevantes para a vida do aluno fora da sala de aula?", en: "Do the proposed tasks simulate language use situations that are credible and relevant to the student's life outside the classroom?"}
                    ]},
                    { title_pt: "Critério 10: Padrões de interação", title_en: "Criterion 10: Interaction Patterns", items: [
                        { id: 'c10_1', essential: true, pt: "O livro sugere consistentemente atividades em pares e em pequenos grupos, ou a maior parte do trabalho é individual e focado no professor?", en: "Does the book consistently suggest activities in pairs and small groups, or is most of the work individual and teacher-focused?" },
                        { id: 'c10_2', essential: true, pt: "As atividades são desenhadas para maximizar o tempo de fala do aluno (Student Talking Time) e promover a negociação de significado entre eles?", en: "Are the activities designed to maximize student talking time (Student Talking Time) and promote negotiation of meaning among them?"}
                    ]},
                     { title_pt: "Critério 11: Equilíbrio entre fluência e precisão", title_en: "Criterion 11: Balance between Fluency and Accuracy", items: [
                        { id: 'c11_1', essential: false, pt: "O material oferece um bom equilíbrio entre atividades de fluência (foco na comunicação livre e na mensagem) e atividades de precisão (foco na correção da forma)?", en: "Does the material offer a good balance between fluency activities (focus on free communication and message) and accuracy activities (focus on correcting the form)?" },
                        { id: 'c11_2', essential: false, pt: "Após uma atividade de fluência, o livro sugere formas de o professor dar um feedback focado na forma, sem desestimular o aluno?", en: "After a fluency activity, does the book suggest ways for the teacher to give form-focused feedback without discouraging the student?"}
                    ]},
                ]
            },
            { // Dimensão 4
                pt: "Conteúdo, Cultura e Fatores Afetivos", en: "Content, Culture, and Affective Factors",
                acronym_pt: "CCFA", acronym_en: "CCAF",
                criteria: [
                     { title_pt: "Critério 12: Relevância e interesse dos tópicos", title_en: "Criterion 12: Topic Relevance and Interest", items: [
                        { id: 'c12_1', essential: false, pt: "Os tópicos abordados são atuais, estimulantes e capazes de gerar discussões e engajamento genuíno em sala de aula?", en: "Are the topics covered current, stimulating, and capable of generating genuine discussions and engagement in the classroom?" },
                        { id: 'c12_2', essential: false, pt: "Os temas são apropriados para a maturidade intelectual e emocional dos alunos?", en: "Are the themes appropriate for the students' intellectual and emotional maturity?"}
                    ]},
                     { title_pt: "Critério 13: Representação cultural", title_en: "Criterion 13: Cultural Representation", items: [
                        { id: 'c13_1', essential: false, pt: "A representação de diferentes culturas no livro evita estereótipos e apresenta uma visão plural e respeitosa?", en: "Does the representation of different cultures in the book avoid stereotypes and present a pluralistic and respectful view?" },
                        { id: 'c13_2', essential: false, pt: "O material vai além de uma visão monolítica (britânica/americana) e inclui perspectivas de outras culturas que utilizam a língua-alvo?", en: "Does the material go beyond a monolithic view (British/American) and include perspectives from other cultures that use the target language?"}
                    ]},
                     { title_pt: "Critério 14: Impacto afetivo", title_en: "Criterion 14: Affective Impact", items: [
                        { id: 'c14_1', essential: false, pt: "O tom geral do livro (instruções, imagens, tipos de tarefa) tende a reduzir a ansiedade e a aumentar a autoconfiança dos alunos para se comunicarem?", en: "Does the overall tone of the book (instructions, images, task types) tend to reduce anxiety and increase students' self-confidence to communicate?" },
                        { id: 'c14_2', essential: false, pt: "O material projeta uma imagem positiva e inclusiva do aprendiz de línguas?", en: "Does the material project a positive and inclusive image of the language learner?"}
                    ]}
                ]
            },
            { // Dimensão 5
                pt: "Design, Usabilidade e Componentes de Suporte", en: "Design, Usability, and Support Components",
                acronym_pt: "DUCS", acronym_en: "DUSC",
                criteria: [
                     { title_pt: "Critério 15: Leiaute e desenho visual", title_en: "Criterion 15: Layout and Visual Design", items: [
                        { id: 'c15_1', essential: false, pt: "O leiaute da página é claro e organizado? As instruções das atividades são fáceis de localizar e compreender?", en: "Is the page layout clear and organized? Are the activity instructions easy to locate and understand?" },
                        { id: 'c15_2', essential: false, pt: "Os elementos visuais (fotos, gráficos, ícones) apoiam a aprendizagem de forma eficaz ou são meramente decorativos e podem causar distração?", en: "Do the visual elements (photos, graphics, icons) effectively support learning or are they merely decorative and potentially distracting?"}
                    ]},
                     { title_pt: "Critério 16: Componentes de suporte", title_en: "Criterion 16: Support Components", items: [
                        { id: 'c16_1', essential: false, pt: "O Livro do Professor oferece orientações pedagógicas claras, justificativas para as atividades, respostas e sugestões de expansão ou adaptação?", en: "Does the Teacher's Book offer clear pedagogical guidance, justifications for activities, answers, and suggestions for expansion or adaptation?" },
                        { id: 'c16_2', essential: false, pt: "O material de áudio/vídeo e os componentes digitais (plataformas, aplicativos) são de boa qualidade, fáceis de acessar e estão bem integrados às lições do livro do aluno?", en: "Are the audio/video material and digital components (platforms, applications) of good quality, easy to access, and well-integrated with the student's book lessons?"}
                    ]},
                     { title_pt: "Critério 17: Viabilidade prática", title_en: "Criterion 17: Practical Viability", items: [
                        { id: 'c17_1', essential: false, pt: "O custo-benefício do pacote completo (livro do aluno, caderno de exercícios, recursos digitais) é adequado para a realidade financeira dos alunos/instituição?", en: "Is the cost-effectiveness of the complete package (student's book, workbook, digital resources) suitable for the financial reality of the students/institution?" },
                        { id: 'c17_2', essential: false, pt: "O material é facilmente encontrado e adquirido no mercado local? O suporte da editora é acessível?", en: "Is the material easily found and purchased in the local market? Is the publisher's support accessible?"}
                    ]}
                ]
            }
        ];

        // --- STATE ---
        let currentLanguage = 'pt';
        let currentDimensionIndex = 0;
        let currentEvaluation = {};
        let resultsChart = null;
        
        // --- DOM ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const setupForm = document.getElementById('setup-form');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // --- FUNCTIONS ---
        const updateUIStrings = () => {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (el.tagName === 'INPUT' && el.placeholder) {
                        el.placeholder = translations[currentLanguage][key];
                    } else {
                        el.innerHTML = translations[currentLanguage][key];
                    }
                }
            });
            document.getElementById('html-lang').lang = currentLanguage;
            if (document.querySelector('.screen.active').id === 'evaluation-screen') {
                renderDimension(currentDimensionIndex);
            }
            if(document.querySelector('.screen.active').id === 'results-screen') {
                showResults();
            }
        };

        const switchLanguage = (lang) => {
            currentLanguage = lang;
            document.getElementById('lang-pt').classList.toggle('active', lang === 'pt');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            updateUIStrings();
        };

        const navigateTo = (screenId) => {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        };

        const startNewEvaluation = () => {
            currentDimensionIndex = 0;
            const bookDetails = {
                title: setupForm.querySelector('#book-title').value.trim() || "Untitled",
                author: setupForm.querySelector('#book-author').value,
                publisher: setupForm.querySelector('#book-publisher').value,
                year: setupForm.querySelector('#book-year').value,
                courseType: setupForm.querySelector('#course-type').value,
                studentProfile: setupForm.querySelector('#student-profile').value,
            };
            currentEvaluation = {
                id: Date.now(),
                details: bookDetails,
                answers: dimensionsData.map(dim => 
                    dim.criteria.map(crit => 
                        crit.items.map(() => 0) // Initialize with 0
                    )
                ),
                observations: new Array(dimensionsData.length).fill("")
            };
            navigateTo('evaluation-screen');
            renderDimension(currentDimensionIndex);
        };
        
        const renderDimension = (index) => {
            const dimension = dimensionsData[index];
            const langKey = currentLanguage;
            
            let dimensionHTML = `<div class="dimension-title">${dimension[langKey]}</div>`;
            dimension.criteria.forEach((crit, critIndex) => {
                dimensionHTML += `<div class="criterion-group"><div class="criterion-group-title">${crit['title_' + langKey]}</div>`;
                crit.items.forEach((item, itemIndex) => {
                    const rating = currentEvaluation.answers[index][critIndex][itemIndex] || 0;
                    dimensionHTML += `
                        <div class="checklist-item">
                            <p>${item[langKey]}</p>
                            <div class="rating-area">
                                <span data-translate-key="likert_1">Discordo</span>
                                <div class="rating-buttons">
                                ${[1,2,3,4,5].map(n => `<input type="radio" id="r_${critIndex}_${itemIndex}_${n}" name="rating_${critIndex}_${itemIndex}" value="${n}" ${rating == n ? 'checked' : ''} data-crit-index="${critIndex}" data-item-index="${itemIndex}"><label for="r_${critIndex}_${itemIndex}_${n}">${n}</label>`).join('')}
                                </div>
                                <span data-translate-key="likert_5">Concordo</span>
                            </div>
                        </div>
                    `;
                });
                dimensionHTML += `</div>`;
            });

            const savedObservation = currentEvaluation.observations[index] || "";
            dimensionHTML += `
                <div id="observation-section">
                    <label for="observation-textarea" data-translate-key="observation_label">Observações sobre esta Dimensão:</label>
                    <textarea id="observation-textarea">${savedObservation}</textarea>
                </div>
            `;

            document.getElementById('dimension-container').innerHTML = dimensionHTML;
            updateUIStrings(); 
            updateNavigation(index);
        };

        const updateNavigation = (index) => {
            const total = dimensionsData.length;
            document.getElementById('progress-bar').style.width = `${((index + 1) / total) * 100}%`;
            document.getElementById('progress-text').textContent = translations[currentLanguage].progress_text.replace('{current}', index + 1).replace('{total}', total);
            prevBtn.disabled = index === 0;
            nextBtn.innerHTML = (index === total - 1) ? translations[currentLanguage].finish_btn : translations[currentLanguage].next_btn;
        };
        
        const handleNavigation = (direction) => {
            // Save ratings
            const radioGroups = document.querySelectorAll('.criterion-group');
            radioGroups.forEach(group => {
                const radios = group.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    if (radio.checked) {
                        const { critIndex, itemIndex } = radio.dataset;
                        currentEvaluation.answers[currentDimensionIndex][parseInt(critIndex)][parseInt(itemIndex)] = parseInt(radio.value);
                    }
                });
            });
            // Save observation
            currentEvaluation.observations[currentDimensionIndex] = document.getElementById('observation-textarea').value;

            if (direction === 'next' && currentDimensionIndex < dimensionsData.length - 1) {
                currentDimensionIndex++;
                renderDimension(currentDimensionIndex);
            } else if (direction === 'prev' && currentDimensionIndex > 0) {
                currentDimensionIndex--;
                renderDimension(currentDimensionIndex);
            } else if (direction === 'next') {
                showResults();
            }
        };

        const showResults = () => {
            navigateTo('results-screen');
            document.getElementById('book-title-result').textContent = currentEvaluation.details.title;

            let essentialFail = false;
            let totalScore = 0;
            let maxScore = 0;

            const dimensionResults = dimensionsData.map((dim, dimIndex) => {
                let dimScore = 0;
                let dimMaxScore = 0;
                dim.criteria.forEach((crit, critIndex) => {
                    crit.items.forEach((item, itemIndex) => {
                        const rating = currentEvaluation.answers[dimIndex][critIndex][itemIndex] || 0;
                        const weight = item.essential ? 2 : 1;
                        dimScore += rating * weight;
                        dimMaxScore += 5 * weight;
                        if (item.essential && rating < 3) {
                            essentialFail = true;
                        }
                    });
                });
                totalScore += dimScore;
                maxScore += dimMaxScore;
                return {
                    title: dim[currentLanguage],
                    percentage: dimMaxScore > 0 ? (dimScore / dimMaxScore) * 100 : 0
                };
            });
            
            const overallPercentage = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

            const scoresContainer = document.getElementById('scores-container');
            scoresContainer.innerHTML = ''; 
            dimensionResults.forEach(res => {
                scoresContainer.innerHTML += `
                    <div class="result-box">
                        <h3>${res.title} (${Math.round(res.percentage)}%)</h3>
                        <div class="dimension-score-bar"><div style="width: ${res.percentage}%;"></div></div>
                    </div>`;
            });
            
            document.getElementById('essential-warning').style.display = essentialFail ? 'block' : 'none';
            document.getElementById('essential-warning').innerHTML = translations[currentLanguage].essential_warning_text;
            
            const obsList = document.getElementById('observations-list');
            obsList.innerHTML = '';
            currentEvaluation.observations.forEach((obs, index) => {
                if(obs.trim() !== '') {
                    obsList.innerHTML += `<div class="obs-item"><strong>${dimensionsData[index][currentLanguage]}:</strong><p>${obs.trim()}</p></div>`;
                }
            });


            const recDiv = document.getElementById('recommendation');
             if (overallPercentage >= 75 && !essentialFail) {
                recDiv.className = 'result-box excellent';
                recDiv.innerHTML = translations[currentLanguage].recommendation_excellent;
            } else if (overallPercentage >= 50) {
                recDiv.className = 'result-box good';
                recDiv.innerHTML = translations[currentLanguage].recommendation_good;
            } else {
                recDiv.className = 'result-box poor';
                recDiv.innerHTML = translations[currentLanguage].recommendation_poor;
            }
            
            renderResultsChart(dimensionResults.map(r => r.percentage));
        };

        const renderResultsChart = (data) => {
            const ctx = document.getElementById('results-chart').getContext('2d');
            const langKey = currentLanguage;
            if (resultsChart) resultsChart.destroy();
            resultsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensionsData.map(d => d['acronym_' + langKey]),
                    datasets: [{
                        label: currentEvaluation.details.title,
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(52, 152, 219, 1)'
                    }]
                },
                options: {
                    scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 14 } } } },
                    plugins: { legend: { display: false } }
                }
            });
        };
        
        const exportToPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const margin = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const usableWidth = pageWidth - 2 * margin;
            let y = margin;

            const checkY = (neededHeight) => {
                if (y + neededHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
            };
            
            // --- Header ---
            doc.setFontSize(18).setFont(undefined, 'bold');
            doc.text(translations[currentLanguage].pdf_report_title, pageWidth / 2, y, { align: 'center' });
            y += 15;

            // --- Book Details ---
            doc.setFontSize(12).setFont(undefined, 'bold');
            doc.text(`${translations[currentLanguage].book_title}:`, margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(currentEvaluation.details.title, margin + 40, y);
            y += 7;

            // --- Chart ---
            const chartCanvas = document.getElementById('results-chart');
            const chartImg = chartCanvas.toDataURL('image/png', 1.0);
            checkY(80);
            doc.addImage(chartImg, 'PNG', margin, y, 80, 80);

            // --- Scores ---
            let scoreX = margin + 90;
            let scoreY = y;
            doc.setFontSize(12).setFont(undefined, 'bold');
            doc.text("Scores:", scoreX, scoreY);
            scoreY += 7;
            doc.setFontSize(10).setFont(undefined, 'normal');
            
            const dimensionResults = dimensionsData.map((dim, dimIndex) => {
                let dimScore = 0, dimMaxScore = 0;
                dim.criteria.forEach((crit, critIndex) => {
                    crit.items.forEach((item, itemIndex) => {
                        const rating = currentEvaluation.answers[dimIndex][critIndex][itemIndex] || 0;
                        const weight = item.essential ? 2 : 1;
                        dimScore += rating * weight;
                        dimMaxScore += 5 * weight;
                    });
                });
                return { title: dim[currentLanguage], percentage: Math.round(dimMaxScore > 0 ? (dimScore / dimMaxScore) * 100 : 0) };
            });

            dimensionResults.forEach(res => {
                doc.text(`${res.title}: ${res.percentage}%`, scoreX, scoreY);
                scoreY += 7;
            });
            
            y += 85;

            // --- Recommendation and Observations ---
            checkY(20);
            const recommendation = document.getElementById('recommendation').innerText;
            doc.setFontSize(12).setFont(undefined, 'bold');
            doc.text("Recomendação Final:", margin, y);
            y += 7;
            doc.setFontSize(10).setFont(undefined, 'normal');
            const recLines = doc.splitTextToSize(recommendation, usableWidth);
            doc.text(recLines, margin, y);
            y += recLines.length * 5 + 10;
            
            checkY(20);
            doc.setFontSize(12).setFont(undefined, 'bold');
            doc.text(translations[currentLanguage].observations_title, margin, y);
            y += 7;
            doc.setFontSize(10).setFont(undefined, 'normal');
            currentEvaluation.observations.forEach((obs, index) => {
                if (obs.trim() !== '') {
                    checkY(15);
                    doc.setFont(undefined, 'bold');
                    doc.text(dimensionsData[index][currentLanguage] + ":", margin, y);
                    y += 5;
                    doc.setFont(undefined, 'normal');
                    const obsLines = doc.splitTextToSize(obs, usableWidth);
                    doc.text(obsLines, margin, y);
                    y += obsLines.length * 5 + 5;
                }
            });


            doc.save(`${currentEvaluation.details.title.replace(/ /g, '_')}_evaluation.pdf`);
        };

        // --- EVENT LISTENERS ---
        document.getElementById('header-title').addEventListener('click', () => navigateTo('home-screen'));
        document.getElementById('home-start-btn').addEventListener('click', () => navigateTo('setup-screen'));
        setupForm.addEventListener('submit', (e) => { e.preventDefault(); startNewEvaluation(); });
        prevBtn.addEventListener('click', () => handleNavigation('prev'));
        nextBtn.addEventListener('click', () => handleNavigation('next'));
        document.getElementById('new-eval-btn').addEventListener('click', () => navigateTo('setup-screen'));
        document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
        document.getElementById('lang-pt').addEventListener('click', () => switchLanguage('pt'));
        document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));
        
        // --- INITIALIZATION ---
        updateUIStrings();
        navigateTo('home-screen');
    });
    </script>
</body>
</html>
