<!DOCTYPE html>
<html lang="pt-BR" id="html-lang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Importando a fonte Noto Sans do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <!-- Incluindo bibliotecas JS para PDF e Gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <title data-translate-key="page_title">Plataforma de Avaliação de Livros</title>
    <style>
        :root {
            --primary-color: #34495e;
            --secondary-color: #2c3e50;
            --accent-color: #3498db;
            --text-color: #333;
            --light-gray: #f8f9fa;
            --white: #fff;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --slider-track: #ccc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #ecf0f1;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 950px;
            width: 100%;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 20px auto;
        }
        
        /* --- HEADER E NAVEGAÇÃO PRINCIPAL --- */
        .main-header {
            background: var(--secondary-color);
            color: var(--white);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .main-header h1 { font-size: 1.5em; cursor: pointer; margin-right: auto; }
        .lang-switcher { display: flex; align-items: center; gap: 5px; }
        .lang-btn { background: transparent; border: 1px solid var(--white); color: var(--white); padding: 5px 10px; cursor: pointer; border-radius: 5px; opacity: 0.7; }
        .lang-btn.active { background-color: rgba(255,255,255,0.3); }

        .screen { display: none; }
        .screen.active { display: block; }
        .screen-content { padding: 30px 40px; }
        
        /* --- TELA INICIAL (HOME) --- */
        .thesis-header { padding: 30px; text-align: center; background-color: var(--light-gray); border-bottom: 1px solid #ddd; }
        .thesis-header .institution { font-size: 1.1em; font-weight: bold; color: var(--primary-color); }
        .thesis-header .campus-course { font-size: 1em; color: #555; margin-bottom: 20px; }
        .thesis-header .author-name { font-size: 1.4em; font-weight: bold; color: var(--secondary-color); margin: 20px 0; text-transform: uppercase; }
        .thesis-header .thesis-title { font-size: 1.2em; font-weight: bold; max-width: 600px; margin: 0 auto 10px auto; }
        .thesis-header .thesis-subtitle { font-size: 1em; font-style: italic; color: #555; margin-bottom: 30px; }
        .thesis-header .advisor { font-size: 0.9em; color: #666; }
        #home-screen .start-section { text-align: center; padding: 40px 20px; }
        #home-start-btn { padding: 15px 30px; font-size: 1.2em; font-weight: bold; color: var(--white); background-color: var(--success); border: none; border-radius: 30px; cursor: pointer; transition: all 0.3s ease; }
        #home-start-btn:hover { background-color: #219d52; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        #home-screen .instructions-section { padding: 40px 20px; }
        #home-screen .instructions-section h3 { text-align: center; font-size: 1.8em; color: var(--secondary-color); margin-bottom: 30px; }
        .steps-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
        .step { text-align: center; width: 200px; }
        .step .step-number {
            width: 60px;
            height: 68px;
            background-color: var(--accent-color);
            color: var(--white);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 15px;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        .step .step-text { font-size: 1em; color: #555; min-height: 50px; }


        /* --- TELA DE INÍCIO (SETUP) --- */
        #setup-screen h2 { color: var(--secondary-color); margin-bottom: 20px; text-align: center; }
        .form-section { margin-bottom: 25px; border-left: 4px solid var(--accent-color); padding-left: 15px; }
        .form-section h3 { margin-bottom: 15px; color: var(--primary-color); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .form-group .optional-text { font-size: 0.8em; opacity: 0.7; font-weight: normal; margin-left: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; font-family: 'Noto Sans', sans-serif; }
        textarea { resize: vertical; min-height: 80px; }
        .start-btn { display: block; width: 100%; padding: 15px; background-color: var(--success); color: var(--white); border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        .start-btn:hover { background-color: #219d52; }
        
        /* --- TELA DE AVALIAÇÃO --- */
        #progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 20px; }
        #progress-bar { width: 0%; height: 10px; background-color: var(--accent-color); border-radius: 5px; transition: width 0.4s ease; }
        .dimension-container { min-height: 400px; padding: 20px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; background-color: var(--light-gray); }
        .dimension-title { font-size: 1.5em; font-weight: bold; margin-bottom: 25px; color: var(--secondary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; }
        .criterion-group { margin-bottom: 30px; }
        .criterion-group-title { font-size: 1.2em; font-weight: bold; color: var(--primary-color); margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .checklist-item { margin-bottom: 20px; padding: 15px; border-radius: 5px; background-color: var(--white); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .checklist-item p { margin-bottom: 10px; font-size: 1.05em; line-height: 1.5; }
        .rating-area { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .rating-area input[type=range] { flex-grow: 1; accent-color: var(--accent-color); cursor: pointer; }
        .rating-value { font-size: 1.2em; font-weight: bold; color: var(--accent-color); min-width: 20px; text-align: center; }
        #observation-section { margin-top: 30px; }
        #observation-section label { font-weight: bold; color: var(--primary-color); }
        #observation-textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; margin-top: 10px; }
        .navigation-controls { display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #prev-btn { background-color: #ddd; }
        #prev-btn:disabled { background-color: #eee; cursor: not-allowed; }
        #next-btn { background-color: var(--primary-color); color: var(--white); }

        /* --- TELA DE RESULTADOS --- */
        #results-screen h2 { text-align: center; color: var(--secondary-color); margin-bottom: 20px; }
        #book-title-result { text-align: center; font-weight: bold; font-size: 1.2em; color: var(--primary-color); margin-bottom: 20px; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: flex-start; }
        #chart-container { max-width: 400px; margin: 0 auto; }
        .scores-container .result-box { padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .scores-container h3 { margin: 0 0 10px 0; font-size: 1.1em; }
        .dimension-score-bar { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 5px; }
        .dimension-score-bar div { height: 10px; background-color: var(--accent-color); border-radius: 5px; transition: width 0.5s; }
        #essential-warning { background-color: #fbeae9; border-left: 5px solid var(--danger); color: var(--danger); display: none; font-weight: bold; }
        #recommendation, #observations-summary { grid-column: 1 / -1; margin-top: 20px; padding: 20px; border-radius: 8px; }
        #observations-summary { background-color: var(--light-gray); border-left: 5px solid #bdc3c7; }
        #observations-summary h3 { color: var(--secondary-color); }
        #observations-summary .obs-item { margin-bottom: 15px; }
        #observations-summary .obs-item strong { color: var(--primary-color); display: block; margin-bottom: 5px;}
        #observations-summary .obs-item p { white-space: pre-wrap; word-wrap: break-word; }
        .action-buttons { text-align: center; margin-top: 30px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .action-btn { padding: 12px 25px; border-radius: 25px; font-size: 1em; font-weight: bold; cursor: pointer; border: none; transition: all 0.3s ease; }
        #export-pdf-btn { background-color: var(--primary-color); color: var(--white); }
        #new-eval-btn { background-color: var(--success); color: var(--white); }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .footer { padding: 20px 40px; text-align: center; font-size: 0.9em; background-color: #e0e0e0; border-top: 1px solid #ccc; color: #666;}
        .footer a { color: var(--primary-color); font-weight: bold; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .results-grid { grid-template-columns: 1fr; }
            .screen-content { padding: 20px 15px; }
            .main-header { flex-direction: column; gap: 10px; }
            .main-header h1 { order: -1; }
            .thesis-header { padding: 20px; }
            .thesis-header h2 { font-size: 1.1em; }
            .steps-container { flex-direction: column; align-items: center; }
            .rating-area { flex-direction: row; align-items: center; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1 id="header-title" data-translate-key="page_title">Plataforma de Avaliação</h1>
            <div class="lang-switcher">
                <button class="lang-btn active" id="lang-pt">PT</button>
                <button class="lang-btn" id="lang-en">EN</button>
            </div>
        </header>
        
        <!-- Screen 0: Home -->
        <div id="home-screen" class="screen active">
             <div class="thesis-header">
                  <p class="institution" data-translate-key="thesis_institution">Instituto Federal de Brasília</p>
                  <p class="campus-course" data-translate-key="thesis_campus_course">Campus Riacho Fundo - Licenciatura em Letras Inglês</p>
                  <p class="author-name" data-translate-key="thesis_author">João Vicente Saliba de Andrade</p>
                  <h2 class="thesis-title" data-translate-key="thesis_title">ANÁLISE DE LIVROS DIDÁTICOS DE INGLÊS:</h2>
                  <p class="thesis-subtitle" data-translate-key="thesis_subtitle">UM GUIA PRÁTICO À LUZ DA ABORDAGEM COMUNICATIVA E DO QECR.</p>
                  <p class="advisor" data-translate-key="thesis_advisor_info">Trabalho de Conclusão de Curso apresentado sob orientação de Ma. Maria Antonia Germano dos Santos Maia</p>
             </div>
             <div class="start-section">
                 <button id="home-start-btn" data-translate-key="home_start_btn">Iniciar Avaliação</button>
             </div>
             <div class="instructions-section">
                 <h3 data-translate-key="home_how_to_use">Como Usar</h3>
                 <div class="steps-container">
                     <div class="step">
                         <div class="step-number">1</div>
                         <p class="step-text" data-translate-key="home_step_1">Preencha os detalhes do livro e o contexto de ensino.</p>
                     </div>
                     <div class="step">
                         <div class="step-number">2</div>
                         <p class="step-text" data-translate-key="home_step_2">Use o controle deslizante para dar uma nota de 1 (discordo) a 5 (concordo) para cada item.</p>
                     </div>
                     <div class="step">
                         <div class="step-number">3</div>
                         <p class="step-text" data-translate-key="home_step_3">Analise os resultados e a recomendação final.</p>
                     </div>
                     <div class="step">
                         <div class="step-number">4</div>
                         <p class="step-text" data-translate-key="home_step_4">Exporte o relatório detalhado em PDF, se desejar.</p>
                     </div>
                 </div>
             </div>
        </div>

        <!-- Screen 1: Setup -->
        <div id="setup-screen" class="screen">
            <div class="screen-content">
                <h2 data-translate-key="setup_title">Informações do Livro e Contexto</h2>
                <form id="setup-form">
                    <div class="form-section">
                        <h3 data-translate-key="book_details_title">Detalhes do Livro</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="book-title" data-translate-key="book_title">Título do Livro</label><input type="text" id="book-title" required></div>
                            <div class="form-group"><label for="book-author" data-translate-key="book_author">Autor(es)<span class="optional-text">(opcional)</span></label><input type="text" id="book-author"></div>
                            <div class="form-group"><label for="book-publisher" data-translate-key="book_publisher">Editora<span class="optional-text">(opcional)</span></label><input type="text" id="book-publisher"></div>
                            <div class="form-group"><label for="book-year" data-translate-key="book_year">Ano<span class="optional-text">(opcional)</span></label><input type="number" id="book-year"></div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3 data-translate-key="context_details_title">Contexto de Ensino</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="course-type" data-translate-key="course_type">Tipo de Curso</label><input type="text" id="course-type" placeholder="Ex: Inglês Geral, Preparatório..."></div>
                            <div class="form-group"><label for="student-profile" data-translate-key="student_profile">Perfil dos Alunos</label><textarea id="student-profile" placeholder="Ex: Adolescentes, B1, 12 alunos..."></textarea></div>
                        </div>
                    </div>
                    <button type="submit" class="start-btn" data-translate-key="start_btn">Continuar para Avaliação</button>
                </form>
            </div>
        </div>

        <!-- Screen 2: Evaluation -->
        <div id="evaluation-screen" class="screen">
            <div class="screen-content">
                <div id="progress-bar-container"><div id="progress-bar"></div></div>
                <div class="dimension-container" id="dimension-container"></div>
                <div class="navigation-controls">
                    <button id="prev-btn" class="nav-btn" data-translate-key="prev_btn">Anterior</button>
                    <span id="progress-text"></span>
                    <button id="next-btn" class="nav-btn" data-translate-key="next_btn">Próximo</button>
                </div>
            </div>
        </div>

        <!-- Screen 3: Results -->
        <div id="results-screen" class="screen">
            <div class="screen-content" id="report-content">
                <h2 data-translate-key="results_title">Resultados da Avaliação</h2>
                <p id="book-title-result"></p>
                <div class="results-grid">
                    <div id="chart-container"><canvas id="results-chart"></canvas></div>
                    <div class="scores-container" id="scores-container">
                        <!-- Dimension scores will be injected here -->
                    </div>
                </div>
                <div id="essential-warning" class="result-box"></div>
                <div id="recommendation" class="result-box"></div>
                <div id="observations-summary" class="result-box">
                    <h3 data-translate-key="observations_title">Observações por Dimensão</h3>
                    <div id="observations-list"></div>
                </div>
            </div>
            <div class="action-buttons screen-content">
                 <button id="new-eval-btn" class="action-btn" data-translate-key="nav_new_eval">Fazer Nova Avaliação</button>
                 <button id="export-pdf-btn" class="action-btn" data-translate-key="export_btn">Exportar PDF</button>
            </div>
        </div>

        <footer class="footer">
            <p data-translate-key="footer_text">Desenvolvido por <a href="https://www.linkedin.com/in/joaosvicente/" target="_blank" rel="noopener noreferrer">João Vicente Saliba de Andrade</a></p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA & CONFIG ---
        const translations = {
            pt: {
                page_title: "Plataforma de Avaliação de Livros",
                nav_new_eval: "Fazer Nova Avaliação",
                home_title: "Guia de Avaliação de Livros Didáticos de Inglês",
                home_intro: "Uma ferramenta prática para professores, adaptada de um Trabalho de Conclusão de Curso (Letras-Inglês, IFB). Avalie materiais de forma criteriosa e fundamentada na Abordagem Comunicativa e no QECR.",
                home_start_btn: "Iniciar Avaliação", home_how_to_use: "Como Usar",
                home_step_1: "Preencha os detalhes do livro e o contexto de ensino.", home_step_2: "Use o controle deslizante para dar uma nota de 1 (discordo) a 5 (concordo) para cada item.", home_step_3: "Analise os resultados e a recomendação final.", home_step_4: "Exporte o relatório detalhado em PDF, se desejar.",
                thesis_institution: "Instituto Federal de Brasília",
                thesis_campus_course: "Campus Riacho Fundo - Licenciatura em Letras Inglês",
                thesis_author: "João Vicente Saliba de Andrade",
                thesis_title: "ANÁLISE DE LIVROS DIDÁTICOS DE INGLÊS:",
                thesis_subtitle: "UM GUIA PRÁTICO À LUZ DA ABORDAGEM COMUNICATIVA E DO QECR.",
                thesis_advisor_info: "Trabalho de Conclusão de Curso apresentado sob orientação de Ma. Maria Antonia Germano dos Santos Maia",
                setup_title: "Informações do Livro e Contexto", book_details_title: "Detalhes do Livro", book_title: "Título do Livro", book_author: "Autor(es)", book_publisher: "Editora", book_year: "Ano",
                context_details_title: "Contexto de Ensino", course_type: "Tipo de Curso", student_profile: "Perfil dos Alunos", start_btn: "Continuar para Avaliação",
                prev_btn: "Anterior", next_btn: "Próximo", finish_btn: "Ver Resultados",
                results_title: "Resultados da Avaliação", total_score: "Pontuação Geral", export_btn: "Exportar PDF",
                progress_text: "Dimensão {current} de {total}",
                observations_title: "Observações por Dimensão",
                observation_label: "Observações sobre esta Dimensão:",
                essential_warning_text: "<strong>ALERTA:</strong> Um ou mais itens essenciais receberam nota baixa (1 ou 2).",
                recommendation_excellent: "<h3>✅ DECISÃO: ADOTAR</h3><p>O livro está fortemente alinhado com os princípios comunicativos. Constitui uma base sólida para o curso.</p>",
                recommendation_good: "<h3>⚠️ DECISÃO: ADOTAR COM ADAPTAÇÕES</h3><p>O livro apresenta um alinhamento razoável, mas possui lacunas. O professor deverá estar preparado para suplementar as áreas deficientes.</p>",
                recommendation_poor: "<h3>❌ DECISÃO: REJEITAR</h3><p>O livro está fracamente alinhado com os princípios comunicativos. O esforço para adaptar seria maior do que procurar uma alternativa.</p>",
                pdf_report_title: "Relatório de Avaliação de Livro Didático",
                footer_text: `Desenvolvido por <a href="https://www.linkedin.com/in/joaosvicente/" target="_blank" rel="noopener noreferrer">João Vicente Saliba de Andrade</a>`
            },
            en: {
                page_title: "Textbook Evaluation Platform",
                nav_new_eval: "Start New Evaluation",
                home_title: "English Textbook Evaluation Guide",
                home_intro: "A practical tool for teachers, adapted from a Graduation Thesis (English Major, IFB). Evaluate materials critically, based on the Communicative Approach and the CEFR.",
                home_start_btn: "Begin Evaluation", 
                home_how_to_use: "How to Use",
                home_step_1: "Complete the fields for the textbook's details and your specific teaching context.", 
                home_step_2: "Use the slider to rate each criterion on a scale from 1 (Strongly Disagree) to 5 (Strongly Agree).", 
                home_step_3: "Analyze the generated results and the final recommendation.", 
                home_step_4: "If desired, export the comprehensive report as a PDF file.",
                thesis_institution: "Federal Institute of Brasília",
                thesis_campus_course: "Riacho Fundo Campus - B.A. in English Education",
                thesis_author: "João Vicente Saliba de Andrade",
                thesis_title: "Evaluating English Language Textbooks:",
                thesis_subtitle: "A Practical Framework Through the Lens of Communicative Language Teaching and the CEFR",
                thesis_advisor_info: "Capstone project presented under the advisement of Maria Antonia Germano dos Santos Maia, M.A.",
                setup_title: "Textbook & Context Information", 
                book_details_title: "Textbook Details", 
                book_title: "Book Title", 
                book_author: "Author(s)", 
                book_publisher: "Publisher", 
                book_year: "Publication Year",
                context_details_title: "Teaching Context", 
                course_type: "Course Type", 
                student_profile: "Student Profile", 
                start_btn: "Proceed to Evaluation",
                prev_btn: "Previous", 
                next_btn: "Next", 
                finish_btn: "View Results",
                results_title: "Evaluation Results", 
                total_score: "Overall Score", 
                export_btn: "Export to PDF",
                progress_text: "Dimension {current} of {total}",
                observations_title: "Comments by Dimension",
                observation_label: "Comments on this Dimension:",
                essential_warning_text: "<strong>WARNING:</strong> One or more essential criteria received a low score (1 or 2). This may indicate a critical weakness.",
                recommendation_excellent: "<h3>✅ DECISION: ADOPT</h3><p>The textbook is strongly aligned with communicative principles and provides a solid foundation for the course.</p>",
                recommendation_good: "<h3>⚠️ DECISÃO: ADOPT WITH ADAPTATIONS</h3><p>The textbook shows reasonable alignment but has notable gaps. The instructor must be prepared to supplement deficient areas.</p>",
                recommendation_poor: "<h3>❌ DECISÃO: REJECT</h3><p>The textbook is weakly aligned with communicative principles. The effort required for adaptation would outweigh the benefit of finding an alternative.</p>",
                pdf_report_title: "Textbook Evaluation Report",
                footer_text: `Developed by <a href="https://www.linkedin.com/in/joaosvicente/" target="_blank" rel="noopener noreferrer">João Vicente Saliba de Andrade</a>`
            }
        };

        const dimensionsData = [
            { 
                pt: "Fundamentação Pedagógica e Alinhamento Curricular", 
                en: "Pedagogical Foundations and Curricular Alignment",
                acronym_pt: "FPAC", acronym_en: "PFCA",
                criteria: [
                    { 
                        title_pt: "Critério 1: Coerência com a Abordagem Comunicativa (AC)", 
                        title_en: "Criterion 1: Coherence with the Communicative Approach", 
                        items: [
                            { id: 'c1_1', essential: true, pt: 'As unidades são organizadas em torno de funções comunicativas (ex: "dar conselhos") ou em torno de tópicos gramaticais isolados (ex: "Present Perfect")?', en: 'Are units structured around communicative functions (e.g., "giving advice") rather than isolated grammatical topics (e.g., "the Present Perfect")?' },
                            { id: 'c1_2', essential: true, pt: "A gramática é apresentada como uma ferramenta para a comunicação ou como um fim em si mesma?", en: "Is grammar presented as a tool for facilitating communication or as an end in itself?"},
                            { id: 'c1_3', essential: true, pt: "O livro me fornece atividades que levam ao uso real da língua ou se limita a exercícios mecânicos de repetição e preenchimento de lacunas?", en: "Does the book provide activities that lead to authentic language use, or is it limited to mechanical drills and fill-in-the-blank exercises?"}
                        ]
                    },
                    { 
                        title_pt: "Critério 2: Alinhamento com o QECR", 
                        title_en: "Criterion 2: CEFR Alignment", 
                        items: [
                            { id: 'c2_1', essential: true, pt: "O livro indica claramente a qual nível do Quadro Europeu Comum de Referência (A1, A2, B1, etc.) ele se destina?", en: "Does the textbook clearly indicate its intended Common European Framework of Reference (CEFR) level (A1, A2, B1, etc.)?" },
                            { id: 'c2_2', essential: false, pt: 'Os objetivos de cada unidade são descritos em termos de capacidades práticas e observáveis ("can-do statements"), como "Ao final da lição, o aluno será capaz de..."?', en: 'Are unit objectives framed as observable, practical "can-do statements" (e.g., "By the end of this lesson, the student will be able to...")?' },
                            { id: 'c2_3', essential: false, pt: "As tarefas e avaliações propostas são visivelmente coerentes com as competências esperadas para o nível declarado?", en: "Are the proposed tasks and assessments demonstrably coherent with the competencies expected for the stated CEFR level?"}
                        ]
                    },
                    { 
                        title_pt: "Critério 3: Adequação ao contexto de ensino", 
                        title_en: "Criterion 3: Suitability for the Teaching Context", 
                        items: [
                            { id: 'c3_1', essential: false, pt: "Os temas, imagens e situações do livro são relevantes e interessantes para a faixa etária e o perfil sociocultural dos meus alunos?", en: "Are the book's themes, images, and scenarios relevant and engaging for the age group and sociocultural background of my students?" },
                            { id: 'c3_2', essential: false, pt: "O material é flexível o suficiente para ser adaptado aos objetivos específicos do meu curso (geral, negócios, preparatório) e à minha carga horária?", en: "Is the material flexible enough to be adapted to specific course objectives (e.g., general English, business, exam preparation) and the allotted instructional hours?"},
                            { id: 'c3_3', essential: false, pt: "O livro considera diferentes estilos de aprendizagem, oferecendo uma variedade de tipos de atividade (visuais, auditivas, cinestésicas)?", en: "Does the textbook cater to diverse learning styles by offering a variety of activity types (e.g., visual, auditory, kinesthetic)?"}
                        ]
                    }
                ]
            },
            { 
                pt: "Desenvolvimento da Competência Comunicativa", 
                en: "Development of Communicative Competence",
                acronym_pt: "DCC", acronym_en: "CCD",
                criteria: [
                     { 
                        title_pt: "Critério 4: Competência gramatical/linguística", 
                        title_en: "Criterion 4: Grammatical/Linguistic Competence", 
                        items: [
                            { id: 'c4_1', essential: false, pt: "A gramática é apresentada dentro de contextos significativos (diálogos, textos), facilitando a compreensão de seu uso?", en: "Is grammar introduced within meaningful contexts (e.g., dialogues, texts), thereby facilitating a deeper understanding of its application?" },
                            { id: 'c4_2', essential: false, pt: "As atividades de prática incentivam o uso indutivo e a descoberta das regras pelos alunos, ou dependem exclusivamente de explicação explícita?", en: "Do practice activities encourage inductive reasoning and student-led discovery of rules, or do they rely solely on explicit, teacher-led explanation?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 5: Competência sociolinguística/interacional", 
                        title_en: "Criterion 5: Sociolinguistic/Interactional Competence", 
                        items: [
                            { id: 'c5_1', essential: false, pt: "O livro expõe os alunos a diferentes registros de fala (formal, informal, neutro) e ensina quando usar cada um?", en: "Does the book expose students to different registers of speech (formal, informal, neutral) and teach the appropriate contexts for each?" },
                            { id: 'c5_2', essential: false, pt: "As atividades trabalham a adequação da linguagem ao contexto social (ex: como falar com uma autoridade vs. como falar com um amigo)?", en: "Do activities address the social appropriacy of language (e.g., how to address a person in authority versus a peer)?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 6: Competência discursiva", 
                        title_en: "Criterion 6: Discourse Competence", 
                        items: [
                            { id: 'c6_1', essential: false, pt: "O material vai além do ensino de frases isoladas, ajudando os alunos a estruturar textos maiores e mais complexos (parágrafos, e-mails, narrativas)?", en: "Does the material move beyond isolated sentences to help students structure larger, more complex texts (e.g., paragraphs, emails, narratives)?" },
                            { id: 'c6_2', essential: false, pt: "O uso de conectores e outros elementos de coesão textual é ensinado e praticado de forma clara?", en: "Is the use of cohesive devices and other discourse markers taught and practiced explicitly?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 7: Competência estratégica", 
                        title_en: "Criterion 7: Strategic Competence", 
                        items: [
                            { id: 'c7_1', essential: false, pt: "O livro ensina, de forma explícita ou implícita, estratégias para lidar com falhas na comunicação (ex: pedir clarificação, parafrasear, usar gestos)?", en: "Does the book, either explicitly or implicitly, teach strategies for managing communication breakdowns (e.g., asking for clarification, paraphrasing, using gestures)?"},
                            { id: 'c7_2', essential: false, pt: "Existem atividades que encorajam os alunos a se arriscarem e se comunicarem mesmo com um repertório linguístico limitado?", en: "Are there activities that encourage students to take risks and communicate effectively even with a limited linguistic repertoire?"}
                        ]
                    }
                ]
            },
            { 
                pt: "Qualidade das Tarefas, Autenticidade e Interação", 
                en: "Task Quality, Authenticity, and Interaction",
                acronym_pt: "QTAI", acronym_en: "TQAI",
                criteria: [
                    { 
                        title_pt: "Critério 8: Tipologia e qualidade das tarefas", 
                        title_en: "Criterion 8: Typology and Quality of Tasks", 
                        items: [
                            { id: 'c8_1', essential: true, pt: 'As atividades principais de cada unidade são "tarefas" com um objetivo comunicativo real (ex: resolver um problema, criar um produto) ou são apenas exercícios linguísticos?', en: 'Are the core activities of each unit genuine communicative tasks with a clear objective (e.g., solving a problem, creating a product), or are they merely linguistic exercises?' },
                            { id: 'c8_2', essential: true, pt: "As tarefas propostas exigem que os alunos foquem primariamente no significado e na mensagem para chegar a um resultado?", en: "Do the proposed tasks require students to focus primarily on meaning and message to achieve an outcome?"}
                        ]
                    },
                    { 
                        title_pt: "Critério 9: Autenticidade", 
                        title_en: "Criterion 9: Authenticity", 
                        items: [
                            { id: 'c9_1', essential: true, pt: "O livro utiliza textos e áudios autênticos ou semi-autênticos (artigos, podcasts, vídeos reais) que exponham os alunos à língua como ela é usada no mundo real?", en: "Does the book incorporate authentic or semi-authentic texts and audio (e.g., articles, podcasts, real-world videos) that expose students to the language as it is naturally used?" },
                            { id: 'c9_2', essential: true, pt: "As tarefas propostas simulam situações de uso da língua que são críveis e relevantes para a vida do aluno fora da sala de aula?", en: "Do the proposed tasks simulate language-use situations that are credible and relevant to the student's life outside the classroom?"}
                        ]
                    },
                    { 
                        title_pt: "Critério 10: Padrões de interação", 
                        title_en: "Criterion 10: Interaction Patterns", 
                        items: [
                            { id: 'c10_1', essential: true, pt: "O livro sugere consistentemente atividades em pares e em pequenos grupos, ou a maior parte do trabalho é individual e focado no professor?", en: "Does the book consistently promote pair work and small-group activities, or is the majority of the work individual and teacher-centered?" },
                            { id: 'c10_2', essential: true, pt: "As atividades são desenhadas para maximizar o tempo de fala do aluno (Student Talking Time) e promover a negociação de significado entre eles?", en: "Are activities designed to maximize Student Talking Time (STT) and foster the negotiation of meaning among learners?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 11: Equilíbrio entre fluência e precisão", 
                        title_en: "Criterion 11: Balance Between Fluency and Accuracy", 
                        items: [
                            { id: 'c11_1', essential: false, pt: "O material oferece um bom equilíbrio entre atividades de fluência (foco na comunicação livre e na mensagem) e atividades de precisão (foco na correção da forma)?", en: "Does the material strike an effective balance between fluency-oriented activities (focus on communication and message) and accuracy-oriented activities (focus on correct form)?" },
                            { id: 'c11_2', essential: false, pt: "Após uma atividade de fluência, o livro sugere formas de o professor dar um feedback focado na forma, sem desestimular o aluno?", en: "Following a fluency activity, does the book suggest methods for the teacher to provide form-focused feedback without discouraging student participation?"}
                        ]
                    },
                ]
            },
            { 
                pt: "Conteúdo, Cultura e Fatores Afetivos", 
                en: "Content, Culture, and Affective Factors",
                acronym_pt: "CCFA", acronym_en: "CCAF",
                criteria: [
                     { 
                        title_pt: "Critério 12: Relevância e interesse dos tópicos", 
                        title_en: "Criterion 12: Relevance and Interest of Topics", 
                        items: [
                            { id: 'c12_1', essential: false, pt: "Os tópicos abordados são atuais, estimulantes e capazes de gerar discussões e engajamento genuíno em sala de aula?", en: "Are the topics current, thought-provoking, and capable of generating genuine discussion and engagement in the classroom?" },
                            { id: 'c12_2', essential: false, pt: "Os temas são apropriados para a maturidade intelectual e emocional dos alunos?", en: "Are the themes appropriate for the students' intellectual and emotional maturity?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 13: Representação cultural", 
                        title_en: "Criterion 13: Cultural Representation", 
                        items: [
                            { id: 'c13_1', essential: false, pt: "A representação de diferentes culturas no livro evita estereótipos e apresenta uma visão plural e respeitosa?", en: "Does the book's portrayal of different cultures avoid stereotypes and present a pluralistic and respectful worldview?" },
                            { id: 'c13_2', essential: false, pt: "O material vai além de uma visão monolítica (britânica/americana) e inclui perspectivas de outras culturas que utilizam a língua-alvo?", en: "Does the material move beyond a monolithic UK/US-centric view to include perspectives from other cultures where English is used?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 14: Impacto afetivo", 
                        title_en: "Criterion 14: Affective Impact", 
                        items: [
                            { id: 'c14_1', essential: false, pt: "O tom geral do livro (instruções, imagens, tipos de tarefa) tende a reduzir a ansiedade e a aumentar a autoconfiança dos alunos para se comunicarem?", en: "Does the overall tone of the book (e.g., instructions, imagery, task types) work to lower student anxiety (the \"affective filter\") and build self-confidence?" },
                            { id: 'c14_2', essential: false, pt: "O material projeta uma imagem positiva e inclusiva do aprendiz de línguas?", en: "Does the material project a positive and inclusive image of the language learner?"}
                        ]
                    }
                ]
            },
            { 
                pt: "Design, Usabilidade e Componentes de Suporte", 
                en: "Design, Usability, and Support Components",
                acronym_pt: "DUCS", acronym_en: "DUSC",
                criteria: [
                     { 
                        title_pt: "Critério 15: Leiaute e desenho visual", 
                        title_en: "Criterion 15: Layout and Visual Design", 
                        items: [
                            { id: 'c15_1', essential: false, pt: "O leiaute da página é claro e organizado? As instruções das atividades são fáceis de localizar e compreender?", en: "Is the page layout clear and uncluttered? Are activity instructions easy to locate and understand?" },
                            { id: 'c15_2', essential: false, pt: "Os elementos visuais (fotos, gráficos, ícones) apoiam a aprendizagem de forma eficaz ou são meramente decorativos e podem causar distração?", en: "Do visual elements (photos, graphics, icons) effectively support learning, or are they merely decorative and potentially distracting?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 16: Componentes de suporte", 
                        title_en: "Criterion 16: Support Components", 
                        items: [
                            { id: 'c16_1', essential: false, pt: "O Livro do Professor oferece orientações pedagógicas claras, justificativas para as atividades, respostas e sugestões de expansão ou adaptação?", en: "Does the Teacher's Edition provide clear pedagogical guidance, rationales for activities, answer keys, and suggestions for extension or adaptation?" },
                            { id: 'c16_2', essential: false, pt: "O material de áudio/vídeo e os componentes digitais (plataformas, aplicativos) são de boa qualidade, fáceis de acessar e estão bem integrados às lições do livro do aluno?", en: "Are the audio/video materials and digital components (e.g., online platforms, apps) of high quality, easily accessible, and well-integrated with the student book lessons?"}
                        ]
                    },
                     { 
                        title_pt: "Critério 17: Viabilidade prática", 
                        title_en: "Criterion 17: Practical Viability", 
                        items: [
                            { id: 'c17_1', essential: false, pt: "O custo-benefício do pacote completo (livro do aluno, caderno de exercícios, recursos digitais) é adequado para a realidade financeira dos alunos/instituição?", en: "Is the cost-benefit analysis of the complete package (student book, workbook, digital resources) suitable for the financial realities of the students and/or the institution?" },
                            { id: 'c17_2', essential: false, pt: "O material é facilmente encontrado e adquirido no mercado local? O suporte da editora é acessível?", en: "Is the material readily available and procurable in the local market? Is publisher support accessible and reliable?"}
                        ]
                    }
                ]
            }
        ];

        // --- STATE ---
        let currentLanguage = 'pt';
        let currentDimensionIndex = 0;
        let currentEvaluation = {};
        let resultsChart = null;
        
        // --- DOM ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const setupForm = document.getElementById('setup-form');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // --- FUNCTIONS ---
        const updateUIStrings = () => {
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (el.tagName === 'INPUT' && el.placeholder) {
                        el.placeholder = translations[currentLanguage][key];
                    } else {
                        el.innerHTML = translations[currentLanguage][key];
                    }
                }
            });
            document.getElementById('html-lang').lang = currentLanguage;
        };

        const switchLanguage = (lang) => {
            currentLanguage = lang;
            document.getElementById('lang-pt').classList.toggle('active', lang === 'pt');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            
            // First, update all static text elements on the page
            updateUIStrings();

            // Then, re-render the content of the active screen if it's dynamic
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                if (activeScreen.id === 'evaluation-screen') {
                    renderDimension(currentDimensionIndex);
                } else if (activeScreen.id === 'results-screen') {
                    // Make sure evaluation data exists before showing results
                    if (currentEvaluation.id) {
                        showResults();
                    }
                }
            }
        };

        const navigateTo = (screenId) => {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const startNewEvaluation = () => {
            currentDimensionIndex = 0;
            const bookDetails = {
                title: setupForm.querySelector('#book-title').value.trim() || "Untitled",
                author: setupForm.querySelector('#book-author').value,
                publisher: setupForm.querySelector('#book-publisher').value,
                year: setupForm.querySelector('#book-year').value,
                courseType: setupForm.querySelector('#course-type').value,
                studentProfile: setupForm.querySelector('#student-profile').value,
            };
            currentEvaluation = {
                id: Date.now(),
                details: bookDetails,
                answers: dimensionsData.map(dim => 
                    dim.criteria.map(crit => 
                        crit.items.map(() => 0) // Initialize with 0
                    )
                ),
                observations: new Array(dimensionsData.length).fill("")
            };
            navigateTo('evaluation-screen');
            renderDimension(currentDimensionIndex);
        };
        
        const renderDimension = (index) => {
            const dimension = dimensionsData[index];
            const langKey = currentLanguage;
            
            let dimensionHTML = `<div class="dimension-title">${dimension[langKey]}</div>`;
            dimension.criteria.forEach((crit, critIndex) => {
                dimensionHTML += `<div class="criterion-group"><div class="criterion-group-title">${crit['title_' + langKey]}</div>`;
                crit.items.forEach((item, itemIndex) => {
                    const rating = currentEvaluation.answers[index][critIndex][itemIndex] || 0;
                    dimensionHTML += `
                        <div class="checklist-item">
                            <p>${item[langKey]}</p>
                            <div class="rating-area">
                                <input type="range" min="1" max="5" value="${rating > 0 ? rating : 3}" class="likert-slider" data-crit-index="${critIndex}" data-item-index="${itemIndex}" oninput="this.nextElementSibling.textContent = this.value">
                                <span class="rating-value">${rating > 0 ? rating : ''}</span>
                            </div>
                        </div>
                    `;
                });
                dimensionHTML += `</div>`;
            });

            const savedObservation = currentEvaluation.observations[index] || "";
            const observationLabelText = translations[currentLanguage].observation_label;
            dimensionHTML += `
                <div id="observation-section">
                    <label for="observation-textarea">${observationLabelText}</label>
                    <textarea id="observation-textarea">${savedObservation}</textarea>
                </div>
            `;

            document.getElementById('dimension-container').innerHTML = dimensionHTML;
            updateNavigation(index);
        };

        const updateNavigation = (index) => {
            const total = dimensionsData.length;
            document.getElementById('progress-bar').style.width = `${((index + 1) / total) * 100}%`;
            document.getElementById('progress-text').textContent = translations[currentLanguage].progress_text.replace('{current}', index + 1).replace('{total}', total);
            prevBtn.disabled = index === 0;
            nextBtn.innerHTML = (index === total - 1) ? translations[currentLanguage].finish_btn : translations[currentLanguage].next_btn;
        };
        
        const handleNavigation = (direction) => {
            const sliders = document.querySelectorAll('.likert-slider');
            sliders.forEach(slider => {
                const { critIndex, itemIndex } = slider.dataset;
                const value = parseInt(slider.value);
                currentEvaluation.answers[currentDimensionIndex][parseInt(critIndex)][parseInt(itemIndex)] = value;
            });
            
            currentEvaluation.observations[currentDimensionIndex] = document.getElementById('observation-textarea').value;

            if (direction === 'next' && currentDimensionIndex < dimensionsData.length - 1) {
                currentDimensionIndex++;
                renderDimension(currentDimensionIndex);
            } else if (direction === 'prev' && currentDimensionIndex > 0) {
                currentDimensionIndex--;
                renderDimension(currentDimensionIndex);
            } else if (direction === 'next') {
                showResults();
            }
        };

        const showResults = () => {
            navigateTo('results-screen');
            document.getElementById('book-title-result').textContent = currentEvaluation.details.title;

            let essentialFail = false;
            let totalScore = 0;
            let maxScore = 0;

            const dimensionResults = dimensionsData.map((dim, dimIndex) => {
                let dimScore = 0;
                let dimMaxScore = 0;
                dim.criteria.forEach((crit, critIndex) => {
                    crit.items.forEach((item, itemIndex) => {
                        const rating = currentEvaluation.answers[dimIndex][critIndex][itemIndex] || 0;
                        const weight = item.essential ? 2 : 1;
                        dimScore += rating * weight;
                        dimMaxScore += 5 * weight;
                        if (item.essential && rating < 3) {
                            essentialFail = true;
                        }
                    });
                });
                totalScore += dimScore;
                maxScore += dimMaxScore;
                return {
                    title: dim[currentLanguage],
                    percentage: dimMaxScore > 0 ? (dimScore / dimMaxScore) * 100 : 0
                };
            });
            
            const overallPercentage = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

            const scoresContainer = document.getElementById('scores-container');
            scoresContainer.innerHTML = ''; 
            dimensionResults.forEach(res => {
                scoresContainer.innerHTML += `
                    <div class="result-box">
                        <h3>${res.title} (${Math.round(res.percentage)}%)</h3>
                        <div class="dimension-score-bar"><div style="width: ${res.percentage}%;"></div></div>
                    </div>`;
            });
            
            document.getElementById('essential-warning').style.display = essentialFail ? 'block' : 'none';
            document.getElementById('essential-warning').innerHTML = translations[currentLanguage].essential_warning_text;
            
            const obsList = document.getElementById('observations-list');
            obsList.innerHTML = '';
            currentEvaluation.observations.forEach((obs, index) => {
                if(obs.trim() !== '') {
                    obsList.innerHTML += `<div class="obs-item"><strong>${dimensionsData[index][currentLanguage]}:</strong><p>${obs.trim()}</p></div>`;
                }
            });


            const recDiv = document.getElementById('recommendation');
             if (overallPercentage >= 75 && !essentialFail) {
                recDiv.className = 'result-box excellent';
                recDiv.innerHTML = translations[currentLanguage].recommendation_excellent;
            } else if (overallPercentage >= 50) {
                recDiv.className = 'result-box good';
                recDiv.innerHTML = translations[currentLanguage].recommendation_good;
            } else {
                recDiv.className = 'result-box poor';
                recDiv.innerHTML = translations[currentLanguage].recommendation_poor;
            }
            
            renderResultsChart(dimensionResults.map(r => r.percentage));
        };

        const renderResultsChart = (data) => {
            const ctx = document.getElementById('results-chart').getContext('2d');
            const langKey = currentLanguage;
            if (resultsChart) resultsChart.destroy();
            resultsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensionsData.map(d => d['acronym_' + langKey]),
                    datasets: [{
                        label: currentEvaluation.details.title,
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(52, 152, 219, 1)'
                    }]
                },
                options: {
                    scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 14 } } } },
                    plugins: { legend: { display: false } }
                }
            });
        };
        
        const exportToPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            // --- Cores e Constantes ---
            const primaryColor = '#34495e';
            const secondaryColor = '#2c3e50';
            const accentColor = '#3498db';
            const textColor = '#333333';
            const lightGray = '#f0f0f0'; // Cor de fundo para seções
            const white = '#ffffff';
            const dangerColor = '#e74c3c';
            const warningColor = '#f39c12';
            const successColor = '#27ae60';

            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const usableWidth = doc.internal.pageSize.getWidth() - (2 * margin);
            let y = margin;

            // --- Funções Auxiliares de Desenho ---
            const addHeaderFooter = () => {
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    // Cabeçalho
                    doc.setFontSize(9);
                    doc.setTextColor(primaryColor);
                    doc.text(translations[currentLanguage].pdf_report_title, margin, margin - 7);
                    doc.setDrawColor(lightGray);
                    doc.line(margin, margin - 4, doc.internal.pageSize.getWidth() - margin, margin - 4);

                    // Rodapé
                    const footerY = pageHeight - margin + 7;
                    doc.line(margin, footerY, doc.internal.pageSize.getWidth() - margin, footerY);
                    doc.setFontSize(8);
                    doc.setTextColor(textColor);
                    const footerText = `Desenvolvido por João Vicente Saliba de Andrade`;
                    doc.text(footerText, margin, footerY + 5);
                    doc.text(`Página ${i} de ${totalPages}`, usableWidth + margin, footerY + 5, { align: 'right' });
                }
            };
            
            const checkAndAddPage = (neededHeight = 20) => {
                if (y + neededHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
            };

            // --- Construção do PDF ---

            // 1. Título do Relatório
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(20);
            doc.setTextColor(primaryColor);
            doc.text(translations[currentLanguage].pdf_report_title, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
            y += 8;
            
            doc.setFontSize(14);
            doc.setTextColor(secondaryColor);
            doc.text(currentEvaluation.details.title, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
            y += 15;
            
            // 2. Seção de Recomendação Final
            checkAndAddPage(40);
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(primaryColor);
            doc.text("Recomendação Final", margin, y);
            y += 6;

            const recDiv = document.getElementById('recommendation');
            let recColor = warningColor;
            if (recDiv.classList.contains('excellent')) recColor = successColor;
            if (recDiv.classList.contains('poor')) recColor = dangerColor;
            
            const recTitle = recDiv.querySelector('h3').innerText.replace(/✅|⚠️|❌/g, '').trim();
            const recText = recDiv.querySelector('p').innerText;

            doc.setFillColor(recColor);
            doc.setDrawColor(recColor);
            doc.rect(margin, y, usableWidth, 10, 'F');
            
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(11);
            doc.setTextColor(white);
            doc.text(recTitle, margin + 5, y + 6.5);
            y += 15;

            doc.setFont('Helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(textColor);
            const recLines = doc.splitTextToSize(recText, usableWidth);
            doc.text(recLines, margin, y);
            y += recLines.length * 5 + 12;

            // 3. Gráfico Radar e Pontuações (Agora com renderização off-screen)
            checkAndAddPage(105);

            // Criar canvas off-screen para renderização em alta resolução
            const offscreenCanvas = document.createElement('canvas');
            const canvasSize = 1000; // Resolução fixa alta para o canvas
            offscreenCanvas.width = canvasSize;
            offscreenCanvas.height = canvasSize;
            const offscreenCtx = offscreenCanvas.getContext('2d');
            
            const dimensionResults = dimensionsData.map((dim, dimIndex) => {
                 let dimScore = 0, dimMaxScore = 0;
                 dim.criteria.forEach((crit, critIndex) => {
                     crit.items.forEach((item, itemIndex) => {
                         const rating = currentEvaluation.answers[dimIndex][critIndex][itemIndex] || 0;
                         const weight = item.essential ? 2 : 1;
                         dimScore += rating * weight;
                         dimMaxScore += 5 * weight;
                     });
                 });
                 return { title: dim[currentLanguage], acronym: dim['acronym_' + currentLanguage], percentage: Math.round(dimMaxScore > 0 ? (dimScore / dimMaxScore) * 100 : 0) };
            });

            // Plugin para desenhar fundo branco no gráfico
            const canvasBKG = {
              id: 'customCanvasBackgroundColor',
              beforeDraw: (chart, args, options) => {
                const {ctx} = chart;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = options.color || '#FFFFFF';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
              }
            };
            
            // Criar uma instância de gráfico temporária no canvas off-screen
            const tempChart = new Chart(offscreenCtx, {
                type: 'radar',
                data: {
                    labels: dimensionsData.map(d => d['acronym_' + currentLanguage]),
                    datasets: [{
                        label: currentEvaluation.details.title,
                        data: dimensionResults.map(r => r.percentage),
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgba(52, 152, 219, 1)'
                    }]
                },
                options: {
                    responsive: false, // crucial para usar tamanho fixo
                    animation: false, // não precisa de animação para imagem estática
                    devicePixelRatio: 4, // renderiza em resolução 4x
                    scales: { 
                        r: { 
                            angleLines: { display: true }, 
                            suggestedMin: 0, 
                            suggestedMax: 100, 
                            pointLabels: { font: { size: 24 } } // Fonte maior para alta resolução
                        } 
                    },
                    plugins: { 
                        legend: { display: false },
                        customCanvasBackgroundColor: {
                            color: 'white',
                        }
                    }
                },
                plugins: [canvasBKG]
            });
            
            // Obter a imagem do gráfico temporário
            const chartImg = tempChart.toBase64Image('image/png', 1.0);
            tempChart.destroy(); // Limpar a instância do gráfico temporário

            const chartPDFSize = 80;
            const scoresX = margin + chartPDFSize + 10;
            const scoresWidth = usableWidth - chartPDFSize - 10;
            
            doc.addImage(chartImg, 'PNG', margin, y, chartPDFSize, chartPDFSize);
            
            let scoreY = y;
            doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(primaryColor);
            doc.text("Pontuação por Dimensão", scoresX, scoreY);
            scoreY += 8;

            dimensionResults.forEach(res => {
                doc.setFontSize(10).setFont('Helvetica', 'bold').setTextColor(secondaryColor);
                
                const titleLines = doc.splitTextToSize(`${res.acronym} - ${res.title}`, scoresWidth);
                doc.text(titleLines, scoresX, scoreY);
                scoreY += titleLines.length * 4 + 2;

                const barWidth = scoresWidth - 12;
                doc.setFillColor(lightGray);
                doc.rect(scoresX, scoreY, barWidth, 4, 'F');
                doc.setFillColor(accentColor);
                doc.rect(scoresX, scoreY, barWidth * (res.percentage / 100), 4, 'F');
                
                doc.setFontSize(9).setFont('Helvetica', 'normal').setTextColor(textColor);
                doc.text(`${res.percentage}%`, scoresX + barWidth + 2, scoreY + 3.5);
                scoreY += 10;
            });
            y += chartPDFSize + 10;

            // 4. Observações por Dimensão
            checkAndAddPage(15);
            doc.setFontSize(12).setFont('Helvetica', 'bold').setTextColor(primaryColor);
            doc.text(translations[currentLanguage].observations_title, margin, y);
            y += 8;
            
            currentEvaluation.observations.forEach((obs, index) => {
                if (obs.trim() !== '') {
                    const obsText = obs.trim();
                    const obsTitle = dimensionsData[index][currentLanguage];
                    const textLines = doc.splitTextToSize(obsText, usableWidth - 6);
                    const neededHeight = textLines.length * 5 + 18;

                    checkAndAddPage(neededHeight);
                    
                    doc.setFillColor(lightGray);
                    doc.setDrawColor(lightGray);
                    doc.roundedRect(margin, y, usableWidth, neededHeight, 2, 2, 'F');
                    
                    doc.setFontSize(11).setFont('Helvetica', 'bold').setTextColor(secondaryColor);
                    doc.text(obsTitle, margin + 3, y + 8);
                    
                    doc.setFontSize(10).setFont('Helvetica', 'normal').setTextColor(textColor);
                    doc.text(textLines, margin + 3, y + 15);
                    
                    y += neededHeight + 7;
                }
            });
            
            // --- Finalização ---
            addHeaderFooter();
            doc.save(`${currentEvaluation.details.title.replace(/\s+/g, '_')}_evaluation_report.pdf`);
        };

        // --- EVENT LISTENERS ---
        document.getElementById('header-title').addEventListener('click', () => navigateTo('home-screen'));
        document.getElementById('home-start-btn').addEventListener('click', () => navigateTo('setup-screen'));
        setupForm.addEventListener('submit', (e) => { e.preventDefault(); startNewEvaluation(); });
        prevBtn.addEventListener('click', () => handleNavigation('prev'));
        nextBtn.addEventListener('click', () => handleNavigation('next'));
        document.getElementById('new-eval-btn').addEventListener('click', () => navigateTo('setup-screen'));
        document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
        document.getElementById('lang-pt').addEventListener('click', () => switchLanguage('pt'));
        document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));
        
        // --- INITIALIZATION ---
        updateUIStrings();
        navigateTo('home-screen');
    });
    </script>
</body>
</html>
